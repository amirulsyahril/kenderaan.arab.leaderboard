<script>
  // === SETKAN URL WEB APP ANDA DI SINI (WAJIB) ===
  let API_BASE = 'https://script.google.com/macros/s/AKfycbwTPz-Cb_LSrVyWoAixaFVPZcaT4ZZwocqWIia0hxOJLEz2nCHG2jDU_5UKr_HERmtfyg/exec'.trim(); // contoh: https://script.google.com/macros/s/AKfycb.../exec
  const API_KEY  = ''; // isi jika Apps Script anda aktifkan kunci (USE_SECRET=true); jika tidak, biar kosong.

  // --- Validasi asas URL (beri mesej awal jika tak sah) ---
  function assertValidUrl(u) {
    try { new URL(u); return true; }
    catch (e) { return false; }
  }

  // Simpan device_id asas (untuk jejak ringan)
  const device_id = (() => {
    const k = 'game_device_id';
    const v = localStorage.getItem(k) || (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()));
    localStorage.setItem(k, v);
    return v;
  })();

  const $ = id => document.getElementById(id);

  async function loadLeaderboard() {
    let url = API_BASE;
    if (API_KEY) url += (url.includes('?') ? '&' : '?') + 'key=' + encodeURIComponent(API_KEY);

    if (!assertValidUrl(url)) {
      $('status').textContent = 'Konfigurasi API_BASE tidak sah. Semak URL /exec.';
      return;
    }

    try {
      const res = await fetch(url, { cache: 'no-store' });
      // Apps Script balas JSON standard → parse
      const json = await res.json();

      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = '';

      if (json.ok && Array.isArray(json.data)) {
        json.data.slice(0, 50).forEach((r, idx) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${idx+1}</td>
            <td>${r.nama||''}</td>
            <td>${r.kelas||''}</td>
            <td>${r.sekolah||''}</td>
            <td>${r.skor??0}</td>`;
          tbody.appendChild(tr);
        });
        $('status').textContent = `Jumlah rekod: ${json.data.length}`;
      } else {
        $('status').textContent = 'Tiada data / ralat.';
      }
    } catch (e) {
      $('status').textContent = 'Gagal muat: ' + (e?.message || e);
    }
  }

  async function submitScore() {
    const nama    = $('nama').value.trim();
    const kelas   = $('kelas').value.trim();
    const sekolah = $('sekolah').value.trim();
    const skor    = $('skor').value;

    if (!nama || !kelas || !sekolah || skor === '') {
      $('submitNote').textContent = 'Sila lengkapkan semua maklumat.';
      return;
    }

    let url = API_BASE;
    if (API_KEY) url += (url.includes('?') ? '&' : '?') + 'key=' + encodeURIComponent(API_KEY);

    if (!assertValidUrl(url)) {
      $('submitNote').textContent = 'Konfigurasi API_BASE tidak sah. Semak URL /exec.';
      return;
    }

    try {
      // Guna text/plain supaya request jadi “simple request” (elak preflight CORS)
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ nama, kelas, sekolah, skor, device_id })
      });

      // Apps Script balas JSON {ok:true/...}
      const json = await res.json();

      if (json.ok) {
        $('submitNote').textContent = 'Skor dihantar!';
        $('skor').value = '';
        await loadLeaderboard();
      } else {
        $('submitNote').textContent = 'Ralat hantar skor: ' + (json.error || 'Tidak diketahui');
      }
    } catch (e) {
      // Inilah mesej yang anda nampak sebelum ini — kini lebih spesifik
      $('submitNote').textContent = 'Gagal hantar: ' + (e?.message || e);
    }
  }

  $('btnSubmit').addEventListener('click', submitScore);
  $('btnRefresh').addEventListener('click', loadLeaderboard);

  // Cuba detect silap awal-awal
  if (!assertValidUrl(API_BASE)) {
    console.warn('API_BASE tidak sah. Pastikan ia URL Web App yang berakhir /exec');
  }

  loadLeaderboard();
</script>
